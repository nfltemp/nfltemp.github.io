<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ko-fi Purchase Monitor - NFL Temp</title>
    
    <!-- React -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.22.5/babel.min.js"></script>

    <!-- Material UI -->
    <script src="https://unpkg.com/@mui/material@5.15.5/umd/material-ui.development.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const {
        Container,
        Typography,
        Paper,
        createTheme,
        ThemeProvider, 
        CssBaseline,
        Button,
        Box,
        Alert,
        Snackbar,
        CircularProgress,
        Stack
      } = MaterialUI;

      const theme = createTheme({
        palette: {
          mode: 'dark',
          primary: { main: '#3AECF8' },
          background: {
            default: '#0F172A',
            paper: 'rgba(30, 41, 59, 0.8)',
          },
        },
      });

      function KofiTest() {
        const [lastWebhook, setLastWebhook] = React.useState(null);
        const [loading, setLoading] = React.useState(false);
        const [error, setError] = React.useState(null);
        const [success, setSuccess] = React.useState(null);
        const [autoRefresh, setAutoRefresh] = React.useState(false);

        const REPO_OWNER = 'nfltemp';
        const REPO_NAME = 'nfltemp.github.io';
        const ISSUE_NUMBER = '1';
        const GITHUB_TOKEN = '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';

        // Function to fetch data from GitHub Issue
        const fetchIssueData = async () => {
          setLoading(true);
          try {
            const response = await fetch(
              `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${ISSUE_NUMBER}`,
              {
                headers: {
                  'Authorization': `Bearer ${GITHUB_TOKEN}`,
                  'Accept': 'application/vnd.github+json',
                  'X-GitHub-Api-Version': '2022-11-28'
                }
              }
            );
            
            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(`GitHub API Error: ${errorData.message}`);
            }
            
            const issueData = await response.json();
            console.log('Raw issue data:', issueData); // Debug log

            try {
              // Clean up the issue body before parsing
              const cleanBody = issueData.body
                .replace(/```json\n?/g, '')
                .replace(/```/g, '')
                .trim();
              
              console.log('Cleaned body:', cleanBody); // Debug log
              const purchaseData = JSON.parse(cleanBody);
              
              setLastWebhook(purchaseData);
              setSuccess('Successfully fetched latest purchase data!');

              if (window.updateRecentBuyers && purchaseData.recentBuyers?.[0]) {
                window.updateRecentBuyers(purchaseData.recentBuyers[0]);
              }
            } catch (jsonError) {
              console.error('JSON Parse Error:', jsonError);
              console.error('Failed to parse:', issueData.body);
              setError(`Failed to parse purchase data: ${jsonError.message}`);
            }
          } catch (err) {
            console.error('Fetch Error:', err);
            setError(err.message);
          } finally {
            setLoading(false);
          }
        };

        // Function to simulate a purchase
        const simulatePurchase = async () => {
          setLoading(true);
          setError(null);
          try {
            const newPurchase = {
              name: "Test User",
              amount: "$20.00",
              purchase: "TESTSCRIPT",
              timestamp: new Date().toISOString(),
              avatar: "https://raw.githubusercontent.com/nfltemp/nfltemp.github.io/refs/heads/main/public/images/packages/AB.PNG"
            };

            // Get current data first
            const response = await fetch(
              `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${ISSUE_NUMBER}`,
              {
                headers: {
                  'Authorization': `Bearer ${GITHUB_TOKEN}`,
                  'Accept': 'application/vnd.github+json',
                  'X-GitHub-Api-Version': '2022-11-28'
                }
              }
            );

            if (!response.ok) throw new Error('Failed to fetch current data');
            
            const issueData = await response.json();
            const currentData = JSON.parse(issueData.body.replace(/```json\n?/g, '').replace(/```/g, '').trim());

            // Update the data
            const updatedData = {
              recentBuyers: [newPurchase, ...(currentData.recentBuyers || []).slice(0, 4)],
              topCustomer: currentData.topCustomer,
              lastUpdated: new Date().toISOString()
            };

            // Update the GitHub issue
            const updateResponse = await fetch(
              `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${ISSUE_NUMBER}`,
              {
                method: 'PATCH',
                headers: {
                  'Authorization': `Bearer ${GITHUB_TOKEN}`,
                  'Accept': 'application/vnd.github+json',
                  'X-GitHub-Api-Version': '2022-11-28',
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  body: JSON.stringify(updatedData, null, 2)
                })
              }
            );

            if (!updateResponse.ok) throw new Error('Failed to update issue');

            setLastWebhook(updatedData);
            setSuccess('Successfully simulated purchase!');
            
            if (window.updateRecentBuyers) {
              window.updateRecentBuyers(newPurchase);
            }
          } catch (err) {
            console.error('Simulation Error:', err);
            setError(err.message);
          } finally {
            setLoading(false);
          }
        };

        // Auto-refresh setup
        React.useEffect(() => {
          let interval;
          if (autoRefresh) {
            interval = setInterval(fetchIssueData, 30000);
          }
          return () => clearInterval(interval);
        }, [autoRefresh]);

        return (
          <ThemeProvider theme={theme}>
            <CssBaseline />
            <Container maxWidth="lg" sx={{ pt: 4, pb: 8 }}>
              <Button 
                variant="outlined" 
                onClick={() => window.location.href = '/'} 
                sx={{ mb: 4 }}
              >
                Back to Home
              </Button>
              
              <Typography variant="h3" gutterBottom sx={{
                background: 'linear-gradient(135deg, #3AECF8 0%, #6366F1 100%)',
                backgroundClip: 'text',
                WebkitBackgroundClip: 'text',
                WebkitTextFillColor: 'transparent',
              }}>
                Ko-fi Purchase Monitor
              </Typography>

              <Paper sx={{ p: 3, mb: 4 }}>
                <Typography variant="h6" gutterBottom>Monitor Controls</Typography>
                <Stack direction="row" spacing={2}>
                  <Button
                    variant="contained"
                    onClick={fetchIssueData}
                    disabled={loading}
                    startIcon={loading && <CircularProgress size={20} />}
                  >
                    Check Latest Purchases
                  </Button>
                  <Button
                    variant="outlined"
                    onClick={simulatePurchase}
                    disabled={loading}
                  >
                    Simulate Purchase
                  </Button>
                  <Button
                    variant={autoRefresh ? "contained" : "outlined"}
                    color={autoRefresh ? "success" : "primary"}
                    onClick={() => setAutoRefresh(!autoRefresh)}
                  >
                    {autoRefresh ? "Auto-Refresh ON" : "Auto-Refresh OFF"}
                  </Button>
                </Stack>
              </Paper>

              {lastWebhook && (
                <Paper sx={{ p: 3 }}>
                  <Typography variant="h6" gutterBottom>Latest Purchase Data</Typography>
                  <Box 
                    component="pre"
                    sx={{ 
                      p: 2, 
                      background: 'rgba(0,0,0,0.2)', 
                      borderRadius: 1,
                      overflow: 'auto'
                    }}
                  >
                    {JSON.stringify(lastWebhook, null, 2)}
                  </Box>
                </Paper>
              )}

              <Paper sx={{ p: 3, mt: 4 }}>
                <Typography variant="h6" gutterBottom>Current Setup</Typography>
                <Typography variant="body2" paragraph>
                  • Monitoring GitHub Issue: <a href="https://github.com/nfltemp/nfltemp.github.io/issues/1" target="_blank" style={{ color: '#3AECF8' }}>Issue #1</a>
                </Typography>
                <Typography variant="body2" paragraph>
                  • Auto-refresh interval: 30 seconds
                </Typography>
                <Typography variant="body2">
                  • Updates are handled by Zapier when Ko-fi purchases occur
                </Typography>
              </Paper>

              <Snackbar 
                open={!!error} 
                autoHideDuration={6000} 
                onClose={() => setError(null)}
              >
                <Alert severity="error" onClose={() => setError(null)}>
                  {error}
                </Alert>
              </Snackbar>

              <Snackbar 
                open={!!success} 
                autoHideDuration={6000} 
                onClose={() => setSuccess(null)}
              >
                <Alert severity="success" onClose={() => setSuccess(null)}>
                  {success}
                </Alert>
              </Snackbar>
            </Container>
          </ThemeProvider>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(
        <React.StrictMode>
          <KofiTest />
        </React.StrictMode>
      );
    </script>
  </body>
</html> 